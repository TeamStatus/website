!function(){module.exports=function(e,t,n,r,u,a){var o={createAuth:function(e,t){return"Basic "+new Buffer(e+":"+t).toString("base64")},getBuildStatus:function(e,t){var n={timeout:o.config.timeout,url:o.config.url+"/rest/api/latest/result/status/"+e+".json",headers:{authorization:o.config.auth}};r(n,function(e,r,u){if(e||!r||200!=r.statusCode){if(!e&&r&&404==r.statusCode)return t(null,{finished:!0});var a="bad response from "+n.url+(r?" - status code: "+r.statusCode:"");return t(e||a)}try{return t(null,JSON.parse(u))}catch(o){return t(o,null)}})},getResponse:function(e,t){var n={timeout:o.config.timeout,url:o.config.url+e,headers:{authorization:o.config.auth}};r(n,function(e,r,u){if(e||!r||200!=r.statusCode){var a=e||"bad response from "+n.url+(r?" - status code: "+r.statusCode:"");return t(e||a,null,r)}return t(null,u,r)})},getJsonResponse:function(e,t){o.getResponse(e,function(e,n){if(e)return t(e,n);var r;try{r=JSON.parse(n)}catch(u){return t(u,null)}return t(null,r)})},getCachedJsonResponse:function(e,t,n){o.maybeCached(e,n,function(){o.getJsonResponse(t,o.cachedCallback(e,n))})},putCache:function(e,t){u.put(e,t,o.config.cacheExpiration)},cachedCallback:function(e,t){return function(n,r){n||o.putCache(e,r),t(n,r)}},maybeCached:function(e,t,n){var r=u.get(e);return r?t(null,r):n(e,t)},getCacheKey:function(e){return"bamboo:server-"+o.config.url+":"+e},getPlanInfo:function(e,t){var n=o.getCacheKey("result-latest-"+e),r="/rest/api/latest/result/"+e+"-latest.json";o.getCachedJsonResponse(n,r,t)},getResponsible:function(e,t){if(!e)return t("build key not found");var n=o.getCacheKey("browse-"+e);return o.maybeCached(n,t,function(){var r="/browse/"+e;o.getResponse(r,function(e,r){if(e)t(e);else{var u=[],s=a.load(r),c=s(".responsible-summary","#page");c.children("ul").children("li").each(function(e,t){var n=s(t).children("img").attr("src"),r=s(t).children("a").text().trim();n||(n=""),u.push({name:r,avatar:n.substr(0,n.indexOf("?"))})}),o.cachedCallback(n,t)(null,u)}})})},getPlansFromProject:function(e,t){if(!e)return t("missing projectKey parameter",null);var n="/rest/api/latest/result/"+e+".json",r=o.getCacheKey("result-"+e);return o.maybeCached(r,t,function(){var u=o.cachedCallback(r,t);return-1!=e.indexOf("-")?u(null,[e]):o.getJsonResponse(n,function(e,n){if(e)t(e);else{var r=[];n.results.result.forEach(function(e){var t=e.key.split("-");t.pop();var n=t.join("-");-1==r.indexOf(n)&&r.push(n)}),u(null,r)}})})}};return o.config={cacheExpiration:1e4,timeout:3e4,auth:o.createAuth(t,n),url:e},o}}();