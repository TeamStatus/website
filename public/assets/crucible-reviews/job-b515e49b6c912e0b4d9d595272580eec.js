var async=require("async"),qs=require("querystring"),util=require("util"),_=require("underscore");module.exports=function(e,r,s){if(!e.server||!e.server.address)return s("No Bamboo server configured");if(!e.server.username||!e.server.password)return s("No Bamboo credentials found");if(!e.teamMembers)return s("No team members configured");if(!e.projects)return s("No projects configured");var t={headers:{authorization:"Basic "+new Buffer(e.server.username+":"+e.server.password).toString("base64")}},a=r.logger,n=e.server.address+"/rest-service/reviews-v1/filter.json?states=Review&",o=(e.server.address+"/rest-service/users-v1/",e.teamMembers.replace(/\s+/g,"").split(",")),u=e.projects.replace(/\s+/g,"").split(",");async.map(o,function(e,s){async.map(u,function(s,o){t.url=n+qs.stringify({author:e,project:s}),a.log("Downloading reviews from "+t.url),r.request(t,function(e,r,s){if(e||!r||200!=r.statusCode){var n=(e||(r?"Bad status code: "+r.statusCode:"Bad response"))+" from "+t.url;a.error(n),o(n)}else{var u;try{u=JSON.parse(s)}catch(i){return a.error("Unable to parse JSON "+i),o(i)}o(null,u.reviewData.length)}})},function(r,t){if(r)s(r,null);else{var a=_.reduce(t,function(e,r){return e+r});s(null,{username:e,openReviews:a})}})},function(r,t){s(r,{baseUrl:e.server.address,reviews:t})})};